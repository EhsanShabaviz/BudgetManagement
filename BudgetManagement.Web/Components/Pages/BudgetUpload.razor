@page "/BudgetUpload"
@rendermode InteractiveServer
@using BudgetManagement.Domain.Entities
@using BudgetManagement.Application.DTOs.Budget
@using BudgetManagement.Application.Interfaces
@using Microsoft.AspNetCore.Components.Forms

@inject IBudgetImportUseCase ImportUseCase
@inject IBudgetCalculationUseCase CalculationUseCase

<h3>بارگذاری اطلاعات</h3>
<div class="card shadow-sm border-0 mb-3" style="direction: rtl; text-align: right;">
    <div class="card-body bg-light rounded-3">
        <p class="mb-0" style="font-size: 1.1rem;">
            📌 لطفاً فایل اکسل اطلاعات کنترل پروژه را با فرمت استاندارد بارگذاری کنید.
        </p>
    </div>
</div>


<div class="d-flex gap-2 align-items-center mb-2">
    <InputFile OnChange="OnInputFileChange" accept=".xlsx,.xls" />
</div>

<div class="d-flex gap-2 mb-2">
    <button class="btn btn-secondary"
            @onclick="Preview"
            disabled="@(_file == null || IsPreviewing || IsPreviewDisabled)">
        @if (IsPreviewing)
        {
            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
        }
        پیش‌نمایش
    </button>

    <button class="btn btn-warning"
            @onclick="CalculateCredit"
            disabled="@(!CanCalculate || IsCalculating)">
        @if (IsCalculating)
        {
            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
        }
        محاسبه اعتبار
    </button>

    <button class="btn btn-primary"
            @onclick="AskImport"
            disabled="@(!CanImport || IsImporting)">
        بارگذاری
    </button>
</div>

@if (ShowSuccessAlert && !IsImporting)
{
    <div class="alert alert-success alert-dismissible fade show alert-soft-enter" role="alert">
        <strong>موفق!</strong> @SuccessMessage
        <button type="button" class="btn-close" aria-label="Close" @onclick="() => ShowSuccessAlert = false"></button>
    </div>
}

@if (PreviewResult != null)
{
    <div class="alert alert-info">
        <p><strong>تعداد کل رکوردها:</strong> @PreviewResult.TotalParsed</p>
        <p><strong>رکوردهای معتبر:</strong> @PreviewResult.TotalValid</p>
        <p><strong>تعداد خطاها:</strong> @(PreviewResult.Errors?.Count ?? 0)</p>
    </div>

    @if (PreviewResult.Errors?.Any() == true)
    {
        <div class="alert alert-warning">
            <ul class="mb-0">
                @foreach (var err in PreviewResult.Errors)
                {
                    <li>@err</li>
                }
            </ul>
        </div>
    }
}

@if (CalculationDone)
{
    <div class="alert alert-success mt-2">
        محاسبات انجام شد. حالا می‌توانید رکوردها را بارگذاری کنید.
    </div>
}

<hr />

<BudgetTable Records="Records" />

@if (ShowConfirmModal)
{
    <div class="modal fade show" tabindex="-1" role="dialog" style="display:block;" aria-modal="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تأیید بارگذاری</h5>
                    <button type="button" class="btn-close" aria-label="Close" @onclick="CloseModal" disabled="@IsImporting"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">
                        @if (PreviewResult is not null)
                        {
                            <span>فایل شامل @PreviewResult.TotalParsed رکورد است که از میان آن‌ها @PreviewResult.TotalValid رکورد معتبر تشخیص داده شد.</span>
                        }
                        <br />
                        آیا می‌خواهید رکوردهای معتبر به پایگاه داده وارد شوند؟
                    </p>

                    @if (IsImporting)
                    {
                        <div class="mb-2">
                            <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="@ImportProgress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     style="width:@($"{ImportProgress}%")">
                                    @ImportProgress%
                                </div>
                            </div>
                            <small class="text-muted d-block mt-1">@ImportProgressText</small>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button"
                            class="btn btn-secondary"
                            @onclick="CloseModal"
                            disabled="@IsImporting">
                        انصراف
                    </button>
                    <button type="button"
                            class="btn btn-danger"
                            @onclick="ConfirmImport"
                            disabled="@IsImporting">
                        @if (IsImporting)
                        {
                            <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                        }
                        بله، بارگذاری کن
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show" @onclick="() => { if (!IsImporting) CloseModal(); }"></div>
}

@code {
    private IBrowserFile? _file;
    private List<BudgetRecord>? Records;
    private ImportBudgetResultDto? PreviewResult;

    private bool ShowConfirmModal;
    private bool IsPreviewing;
    private bool IsImporting;
    private bool IsCalculating;
    private bool CalculationDone;
    private bool IsPreviewDisabled; // کنترل غیرفعال بودن دکمه پیش‌نمایش


    private bool ShowSuccessAlert;
    private string? SuccessMessage;
    private string? Status;

    private int ImportProgress;
    private string? ImportProgressText;

    private bool CanCalculate => Records?.Any() == true;
    private bool CanImport => CalculationDone && (PreviewResult?.TotalValid ?? 0) > 0;

    private void OnInputFileChange(InputFileChangeEventArgs e)
    {
        _file = e.File;
        Records = null;
        PreviewResult = null;
        ShowConfirmModal = false;
        IsImporting = false;
        IsCalculating = false;
        CalculationDone = false;
        ImportProgress = 0;
        ImportProgressText = null;
        ShowSuccessAlert = false;
        SuccessMessage = null;
        IsPreviewDisabled = false; // با انتخاب فایل جدید دوباره فعال می‌شود
        Status = _file != null ? $"فایل انتخاب شد: {_file.Name}" : "فایلی انتخاب نشد.";
    }

    private async Task Preview()
    {
        if (_file == null || IsPreviewing) return;

        try
        {
            IsPreviewing = true;
            ShowConfirmModal = false;
            ShowSuccessAlert = false;
            Status = "در حال پیش‌نمایش...";

            await using var ms = new MemoryStream();
            await _file.OpenReadStream(1024L * 1024 * 64).CopyToAsync(ms);
            ms.Position = 0;

            PreviewResult = await ImportUseCase.PreviewAsync(ms);
            Records = PreviewResult.ValidRecords;

            Status = (PreviewResult.TotalValid > 0)
                ? "پیش‌نمایش کامل شد. رکوردهای معتبر آمادهٔ محاسبه اعتبار هستند."
                : "پیش‌نمایش کامل شد. رکورد معتبری یافت نشد.";
        }
        catch (Exception ex)
        {
            Status = $"خطا در پیش‌نمایش: {ex.Message}";
        }
        finally
        {
            IsPreviewing = false;
            StateHasChanged();
        }
    }

    private async Task CalculateCredit()
    {
        if (Records == null || IsCalculating) return;

        try
        {
            IsCalculating = true;
            IsPreviewDisabled = true; //از لحظه شروع محاسبه، پیش‌نمایش غیرفعال شود
            Status = "در حال محاسبه اعتبار...";

            await CalculationUseCase.CalculateAsync(Records);

            CalculationDone = true;
            Status = "محاسبه اعتبار با موفقیت انجام شد.";

            // 🔄 رفرش جدول با داده‌های جدید
            Records = Records.Select(r => r).ToList(); // ایجاد لیست جدید برای تحریک رندر
            StateHasChanged(); // رفرش UI
        }
        catch (Exception ex)
        {
            Status = $"خطا در محاسبه اعتبار: {ex.Message}";
        }
        finally
        {
            IsCalculating = false;
        }
    }


    private void AskImport()
    {
        if (!CanImport || _file == null) return;
        ShowConfirmModal = true;
        ShowSuccessAlert = false;
    }

    private void CloseModal()
    {
        if (IsImporting) return;
        ShowConfirmModal = false;
    }

    private async Task ConfirmImport()
    {
        await ImportAsync();
        ShowConfirmModal = false;
        StateHasChanged();
    }

    private async Task ImportAsync()
    {
        if (_file == null || IsImporting) return;

        try
        {
            IsImporting = true;
            ImportProgress = 0;
            ImportProgressText = "در حال خواندن فایل...";
            Status = "در حال بارگذاری...";

            await using var ms = new MemoryStream();
            await using var src = _file.OpenReadStream(1024L * 1024 * 64);
            var totalBytes = _file.Size;
            var buffer = new byte[81920];
            long totalRead = 0;

            int read;
            while ((read = await src.ReadAsync(buffer, 0, buffer.Length)) > 0)
            {
                await ms.WriteAsync(buffer.AsMemory(0, read));
                totalRead += read;

                // تا 80٪ پیشرفت برای مرحله خواندن فایل
                ImportProgress = (int)Math.Round((totalRead / (double)totalBytes) * 80);
                StateHasChanged();
            }

            ms.Position = 0;

            // مرحله پردازش
            ImportProgressText = "در حال پردازش داده‌ها...";
            ImportProgress = Math.Max(ImportProgress, 85);
            StateHasChanged();

            var result = await ImportUseCase.ImportAsync(Records!);

            // اتمام
            ImportProgress = 100;
            ImportProgressText = "بارگذاری با موفقیت انجام شد.";
            StateHasChanged();

            SuccessMessage = $"بارگذاری با موفقیت انجام شد. نتیجه: درج {result.InsertedCount} | به‌روزرسانی {result.UpdatedCount}";
            ShowSuccessAlert = true;

            // ✅ پاک‌سازی صفحه و حافظه
            Records = null;
            PreviewResult = null;
            CalculationDone = false;
            ShowConfirmModal = false;
            IsPreviewing = false;
            IsCalculating = false;
            ImportProgress = 0;
            ImportProgressText = null;
            IsPreviewDisabled = false; // بعد از اتمام بارگذاری، برای فایل جدید فعال می‌شود
            Status = "فایل قبلی با موفقیت بارگذاری شد. لطفاً فایل جدید انتخاب کنید.";
            _file = null; // ریست فایل انتخاب‌شده
        }
        catch (Exception ex)
        {
            Status = $"خطا در بارگذاری: {ex.Message}";
        }
        finally
        {
            IsImporting = false;
            StateHasChanged();
        }
    }

}
